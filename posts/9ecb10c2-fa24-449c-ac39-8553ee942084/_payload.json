[{"data":1,"prerenderedAt":226},["Reactive",2],{"content-query-s5PKdvHPYJ":3},{"_path":4,"_dir":5,"_draft":6,"_partial":6,"_locale":7,"title":8,"description":9,"tags":10,"date":14,"body":15,"_type":221,"_id":222,"_source":223,"_file":224,"_extension":225},"/posts/9ecb10c2-fa24-449c-ac39-8553ee942084","posts",false,"","nuxt에서 localstorage 이슈","기존에 cookie에 auth 정보를 저장했을때는 미들웨어가 잘 동작을 했는데, 테스트상 localstorage에 저장을 해보니 미들웨어가 제대로 동작을 안한다.",[11,12,13],"nuxt","ssr","middleware","2024-01-16T00:00:00.000Z",{"type":16,"children":17,"toc":217},"root",[18,25,30,43,48,52,57,62,66,73,170,174,204,208,213],{"type":19,"tag":20,"props":21,"children":22},"element","p",{},[23],{"type":24,"value":9},"text",{"type":19,"tag":20,"props":26,"children":27},{},[28],{"type":24,"value":29},"\\n",{"type":19,"tag":31,"props":32,"children":37},"pre",{"className":33,"code":35,"language":36,"meta":7},[34],"language-javascript","import { useAuthStore } from \"~/store/auth\";\n\nexport default defineNuxtRouteMiddleware((to, from) => {\n\n    const authStore = useAuthStore();\n    const nonAuthPages = ['index', 'login'];\n    if (authStore.isAuthenticated) {\n        if (nonAuthPages.includes(to.name)) {\n            return navigateTo('/dashboard');\n        }\n    } else {\n        if (!nonAuthPages.includes(to.name)) {\n            return navigateTo('/login');\n        }\n    }\n}\n","javascript",[38],{"type":19,"tag":39,"props":40,"children":41},"code",{"__ignoreMap":7},[42],{"type":24,"value":35},{"type":19,"tag":20,"props":44,"children":45},{},[46],{"type":24,"value":47},"위 코드를 보면 로그인하면 index, login 페이지 접근 못하게, 로그인 안하면 index, login을 제외한 나머지 페이지 접근 못하게 코드를 짰다.",{"type":19,"tag":20,"props":49,"children":50},{},[51],{"type":24,"value":29},{"type":19,"tag":20,"props":53,"children":54},{},[55],{"type":24,"value":56},"로그인한 상태에서는 organization으로 접근을 해야하는데 login 페이지를 거쳐서 dashboard로 이동을 한다.",{"type":19,"tag":20,"props":58,"children":59},{},[60],{"type":24,"value":61},"원인을 살펴보니 ssr에서 localStorage에 접근을 못하여 예상하지 못한 로직으로 흐름이 발생한거였다. (server-side에서는 cookie에만 접근이 가능하다.)",{"type":19,"tag":20,"props":63,"children":64},{},[65],{"type":24,"value":29},{"type":19,"tag":67,"props":68,"children":70},"h2",{"id":69},"localstorage에-auth정보-저장-시-흐름-isauthenticated는-true",[71],{"type":24,"value":72},"localStorage에 auth정보 저장 시 흐름 (isAuthenticated는 true)",{"type":19,"tag":74,"props":75,"children":76},"ol",{},[77,104,129,134,165],{"type":19,"tag":78,"props":79,"children":80},"li",{},[81,83],{"type":24,"value":82},"organization 페이지에 접근\n",{"type":19,"tag":74,"props":84,"children":85},{},[86],{"type":19,"tag":78,"props":87,"children":88},{},[89,91],{"type":24,"value":90},"server-side에서 middleware 동작\n",{"type":19,"tag":74,"props":92,"children":93},{},[94,99],{"type":19,"tag":78,"props":95,"children":96},{},[97],{"type":24,"value":98},"이때 server-side에서는 localstorage에 접근을 못하니까 authStore 정보를 못 얻어온다.",{"type":19,"tag":78,"props":100,"children":101},{},[102],{"type":24,"value":103},"navigateTo(’/login’)이 실행된다.",{"type":19,"tag":78,"props":105,"children":106},{},[107,109],{"type":24,"value":108},"login 페이지 접근\n",{"type":19,"tag":74,"props":110,"children":111},{},[112],{"type":19,"tag":78,"props":113,"children":114},{},[115,117],{"type":24,"value":116},"server-side에서 middleware가 동작\n",{"type":19,"tag":74,"props":118,"children":119},{},[120,125],{"type":19,"tag":78,"props":121,"children":122},{},[123],{"type":24,"value":124},"마찬가지로 server-side에서는 localstorage에 접근을 못하니까 authStore 정보를 못 얻어온다.",{"type":19,"tag":78,"props":126,"children":127},{},[128],{"type":24,"value":103},{"type":19,"tag":78,"props":130,"children":131},{},[132],{"type":24,"value":133},"같은 페이지로 리다이렉트 됐기 때문에 더이상 ssr은 실행되지 않고 csr이 실행된다.",{"type":19,"tag":78,"props":135,"children":136},{},[137,139],{"type":24,"value":138},"login 화면이 렌더링\n",{"type":19,"tag":74,"props":140,"children":141},{},[142],{"type":19,"tag":78,"props":143,"children":144},{},[145,147],{"type":24,"value":146},"client-side에서 middleware 동작\n",{"type":19,"tag":74,"props":148,"children":149},{},[150,155,160],{"type":19,"tag":78,"props":151,"children":152},{},[153],{"type":24,"value":154},"csr에서는 localstorage에 접근이 가능하기 때문에 authStore 정보를 얻어옴",{"type":19,"tag":78,"props":156,"children":157},{},[158],{"type":24,"value":159},"nonAuthPages에 포함됨",{"type":19,"tag":78,"props":161,"children":162},{},[163],{"type":24,"value":164},"navigateTo(’dashboard’)이 실행된다.",{"type":19,"tag":78,"props":166,"children":167},{},[168],{"type":24,"value":169},"dashboard 화면이 렌더링 (client-side에서 middleware 동작은 생략)",{"type":19,"tag":20,"props":171,"children":172},{},[173],{"type":24,"value":29},{"type":19,"tag":175,"props":176,"children":177},"blockquote",{},[178],{"type":19,"tag":20,"props":179,"children":180},{},[181,183,189,191,195,197,202],{"type":24,"value":182},"SSR 환경에서의 ",{"type":19,"tag":39,"props":184,"children":186},{"className":185},[],[187],{"type":24,"value":188},"navigateTo",{"type":24,"value":190},"는 먼저 서버 측에서 처리되고 그 후 클라이언트 측에서 렌더링된다.",{"type":19,"tag":192,"props":193,"children":194},"br",{},[],{"type":24,"value":196},"\n반면, CSR 환경에서의 ",{"type":19,"tag":39,"props":198,"children":200},{"className":199},[],[201],{"type":24,"value":188},{"type":24,"value":203},"는 클라이언트 측에서만 처리되며, 서버 측 처리는 발생하지 않는다.",{"type":19,"tag":20,"props":205,"children":206},{},[207],{"type":24,"value":29},{"type":19,"tag":209,"props":210,"children":212},"img",{"src":211},"../images/61f4bef1-ed9d-4d20-baa7-5748e821073b.png",[],{"type":19,"tag":214,"props":215,"children":216},"hr",{},[],{"title":7,"searchDepth":218,"depth":218,"links":219},2,[220],{"id":69,"depth":218,"text":72},"markdown","content:posts:9ecb10c2-fa24-449c-ac39-8553ee942084.md","content","posts/9ecb10c2-fa24-449c-ac39-8553ee942084.md","md",1706960670421]