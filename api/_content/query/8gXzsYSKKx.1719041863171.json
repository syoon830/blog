{"_path":"/posts/9ecb10c2-fa24-449c-ac39-8553ee942084","_dir":"posts","_draft":false,"_partial":false,"_locale":"","title":"nuxt에서 localstorage 이슈","description":"기존에 cookie에 auth 정보를 저장했을때는 미들웨어가 잘 동작을 했는데, 테스트상 localstorage에 저장을 해보니 미들웨어가 제대로 동작을 안한다.","tags":["nuxt","ssr","middleware"],"date":"2024-01-16T00:00:00.000Z","body":{"type":"root","children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"기존에 cookie에 auth 정보를 저장했을때는 미들웨어가 잘 동작을 했는데, 테스트상 localstorage에 저장을 해보니 미들웨어가 제대로 동작을 안한다."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"\\n"}]},{"type":"element","tag":"pre","props":{"className":["language-javascript"],"code":"import { useAuthStore } from \"~/store/auth\";\n\nexport default defineNuxtRouteMiddleware((to, from) => {\n\n    const authStore = useAuthStore();\n    const nonAuthPages = ['index', 'login'];\n    if (authStore.isAuthenticated) {\n        if (nonAuthPages.includes(to.name)) {\n            return navigateTo('/dashboard');\n        }\n    } else {\n        if (!nonAuthPages.includes(to.name)) {\n            return navigateTo('/login');\n        }\n    }\n}\n","language":"javascript","meta":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"import { useAuthStore } from \"~/store/auth\";\n\nexport default defineNuxtRouteMiddleware((to, from) => {\n\n    const authStore = useAuthStore();\n    const nonAuthPages = ['index', 'login'];\n    if (authStore.isAuthenticated) {\n        if (nonAuthPages.includes(to.name)) {\n            return navigateTo('/dashboard');\n        }\n    } else {\n        if (!nonAuthPages.includes(to.name)) {\n            return navigateTo('/login');\n        }\n    }\n}\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"위 코드를 보면 로그인하면 index, login 페이지 접근 못하게, 로그인 안하면 index, login을 제외한 나머지 페이지 접근 못하게 코드를 짰다."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"\\n"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"로그인한 상태에서는 organization으로 접근을 해야하는데 login 페이지를 거쳐서 dashboard로 이동을 한다."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"원인을 살펴보니 ssr에서 localStorage에 접근을 못하여 예상하지 못한 로직으로 흐름이 발생한거였다. (server-side에서는 cookie에만 접근이 가능하다.)"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"\\n"}]},{"type":"element","tag":"h2","props":{"id":"localstorage에-auth정보-저장-시-흐름-isauthenticated는-true"},"children":[{"type":"text","value":"localStorage에 auth정보 저장 시 흐름 (isAuthenticated는 true)"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"organization 페이지에 접근\n"},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"server-side에서 middleware 동작\n"},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"이때 server-side에서는 localstorage에 접근을 못하니까 authStore 정보를 못 얻어온다."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"navigateTo(’/login’)이 실행된다."}]}]}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"login 페이지 접근\n"},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"server-side에서 middleware가 동작\n"},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"마찬가지로 server-side에서는 localstorage에 접근을 못하니까 authStore 정보를 못 얻어온다."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"navigateTo(’/login’)이 실행된다."}]}]}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"같은 페이지로 리다이렉트 됐기 때문에 더이상 ssr은 실행되지 않고 csr이 실행된다."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"login 화면이 렌더링\n"},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"client-side에서 middleware 동작\n"},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"csr에서는 localstorage에 접근이 가능하기 때문에 authStore 정보를 얻어옴"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"nonAuthPages에 포함됨"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"navigateTo(’dashboard’)이 실행된다."}]}]}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"dashboard 화면이 렌더링 (client-side에서 middleware 동작은 생략)"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"\\n"}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"SSR 환경에서의 "},{"type":"element","tag":"code","props":{},"children":[{"type":"text","value":"navigateTo"}]},{"type":"text","value":"는 먼저 서버 측에서 처리되고 그 후 클라이언트 측에서 렌더링된다.\n반면, CSR 환경에서의 "},{"type":"element","tag":"code","props":{},"children":[{"type":"text","value":"navigateTo"}]},{"type":"text","value":"는 클라이언트 측에서만 처리되며, 서버 측 처리는 발생하지 않는다."}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"\\n"}]},{"type":"element","tag":"img","props":{"src":"/blog/images/290993b5-b070-42f8-a60b-91955bb858a5.png"},"children":[]},{"type":"element","tag":"hr","props":{},"children":[]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"localstorage에-auth정보-저장-시-흐름-isauthenticated는-true","depth":2,"text":"localStorage에 auth정보 저장 시 흐름 (isAuthenticated는 true)"}]}},"_type":"markdown","_id":"content:posts:9ecb10c2-fa24-449c-ac39-8553ee942084.md","_source":"content","_file":"posts/9ecb10c2-fa24-449c-ac39-8553ee942084.md","_extension":"md"}