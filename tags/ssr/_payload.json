[{"data":1,"prerenderedAt":227},["Reactive",2],{"content-query-oCXcf3F4b3":3},[4],{"_path":5,"_dir":6,"_draft":7,"_partial":7,"_locale":8,"title":9,"description":10,"tags":11,"date":15,"body":16,"_type":222,"_id":223,"_source":224,"_file":225,"_extension":226},"/posts/9ecb10c2-fa24-449c-ac39-8553ee942084","posts",false,"","nuxt에서 localstorage 이슈","기존에 cookie에 auth 정보를 저장했을때는 미들웨어가 잘 동작을 했는데, 테스트상 localstorage에 저장을 해보니 미들웨어가 제대로 동작을 안한다.",[12,13,14],"nuxt","ssr","middleware","2024-01-16T00:00:00.000Z",{"type":17,"children":18,"toc":218},"root",[19,26,31,44,49,53,58,63,67,74,171,175,205,209,214],{"type":20,"tag":21,"props":22,"children":23},"element","p",{},[24],{"type":25,"value":10},"text",{"type":20,"tag":21,"props":27,"children":28},{},[29],{"type":25,"value":30},"\\n",{"type":20,"tag":32,"props":33,"children":38},"pre",{"className":34,"code":36,"language":37,"meta":8},[35],"language-javascript","import { useAuthStore } from \"~/store/auth\";\n\nexport default defineNuxtRouteMiddleware((to, from) => {\n\n    const authStore = useAuthStore();\n    const nonAuthPages = ['index', 'login'];\n    if (authStore.isAuthenticated) {\n        if (nonAuthPages.includes(to.name)) {\n            return navigateTo('/dashboard');\n        }\n    } else {\n        if (!nonAuthPages.includes(to.name)) {\n            return navigateTo('/login');\n        }\n    }\n}\n","javascript",[39],{"type":20,"tag":40,"props":41,"children":42},"code",{"__ignoreMap":8},[43],{"type":25,"value":36},{"type":20,"tag":21,"props":45,"children":46},{},[47],{"type":25,"value":48},"위 코드를 보면 로그인하면 index, login 페이지 접근 못하게, 로그인 안하면 index, login을 제외한 나머지 페이지 접근 못하게 코드를 짰다.",{"type":20,"tag":21,"props":50,"children":51},{},[52],{"type":25,"value":30},{"type":20,"tag":21,"props":54,"children":55},{},[56],{"type":25,"value":57},"로그인한 상태에서는 organization으로 접근을 해야하는데 login 페이지를 거쳐서 dashboard로 이동을 한다.",{"type":20,"tag":21,"props":59,"children":60},{},[61],{"type":25,"value":62},"원인을 살펴보니 ssr에서 localStorage에 접근을 못하여 예상하지 못한 로직으로 흐름이 발생한거였다. (server-side에서는 cookie에만 접근이 가능하다.)",{"type":20,"tag":21,"props":64,"children":65},{},[66],{"type":25,"value":30},{"type":20,"tag":68,"props":69,"children":71},"h2",{"id":70},"localstorage에-auth정보-저장-시-흐름-isauthenticated는-true",[72],{"type":25,"value":73},"localStorage에 auth정보 저장 시 흐름 (isAuthenticated는 true)",{"type":20,"tag":75,"props":76,"children":77},"ol",{},[78,105,130,135,166],{"type":20,"tag":79,"props":80,"children":81},"li",{},[82,84],{"type":25,"value":83},"organization 페이지에 접근\n",{"type":20,"tag":75,"props":85,"children":86},{},[87],{"type":20,"tag":79,"props":88,"children":89},{},[90,92],{"type":25,"value":91},"server-side에서 middleware 동작\n",{"type":20,"tag":75,"props":93,"children":94},{},[95,100],{"type":20,"tag":79,"props":96,"children":97},{},[98],{"type":25,"value":99},"이때 server-side에서는 localstorage에 접근을 못하니까 authStore 정보를 못 얻어온다.",{"type":20,"tag":79,"props":101,"children":102},{},[103],{"type":25,"value":104},"navigateTo(’/login’)이 실행된다.",{"type":20,"tag":79,"props":106,"children":107},{},[108,110],{"type":25,"value":109},"login 페이지 접근\n",{"type":20,"tag":75,"props":111,"children":112},{},[113],{"type":20,"tag":79,"props":114,"children":115},{},[116,118],{"type":25,"value":117},"server-side에서 middleware가 동작\n",{"type":20,"tag":75,"props":119,"children":120},{},[121,126],{"type":20,"tag":79,"props":122,"children":123},{},[124],{"type":25,"value":125},"마찬가지로 server-side에서는 localstorage에 접근을 못하니까 authStore 정보를 못 얻어온다.",{"type":20,"tag":79,"props":127,"children":128},{},[129],{"type":25,"value":104},{"type":20,"tag":79,"props":131,"children":132},{},[133],{"type":25,"value":134},"같은 페이지로 리다이렉트 됐기 때문에 더이상 ssr은 실행되지 않고 csr이 실행된다.",{"type":20,"tag":79,"props":136,"children":137},{},[138,140],{"type":25,"value":139},"login 화면이 렌더링\n",{"type":20,"tag":75,"props":141,"children":142},{},[143],{"type":20,"tag":79,"props":144,"children":145},{},[146,148],{"type":25,"value":147},"client-side에서 middleware 동작\n",{"type":20,"tag":75,"props":149,"children":150},{},[151,156,161],{"type":20,"tag":79,"props":152,"children":153},{},[154],{"type":25,"value":155},"csr에서는 localstorage에 접근이 가능하기 때문에 authStore 정보를 얻어옴",{"type":20,"tag":79,"props":157,"children":158},{},[159],{"type":25,"value":160},"nonAuthPages에 포함됨",{"type":20,"tag":79,"props":162,"children":163},{},[164],{"type":25,"value":165},"navigateTo(’dashboard’)이 실행된다.",{"type":20,"tag":79,"props":167,"children":168},{},[169],{"type":25,"value":170},"dashboard 화면이 렌더링 (client-side에서 middleware 동작은 생략)",{"type":20,"tag":21,"props":172,"children":173},{},[174],{"type":25,"value":30},{"type":20,"tag":176,"props":177,"children":178},"blockquote",{},[179],{"type":20,"tag":21,"props":180,"children":181},{},[182,184,190,192,196,198,203],{"type":25,"value":183},"SSR 환경에서의 ",{"type":20,"tag":40,"props":185,"children":187},{"className":186},[],[188],{"type":25,"value":189},"navigateTo",{"type":25,"value":191},"는 먼저 서버 측에서 처리되고 그 후 클라이언트 측에서 렌더링된다.",{"type":20,"tag":193,"props":194,"children":195},"br",{},[],{"type":25,"value":197},"\n반면, CSR 환경에서의 ",{"type":20,"tag":40,"props":199,"children":201},{"className":200},[],[202],{"type":25,"value":189},{"type":25,"value":204},"는 클라이언트 측에서만 처리되며, 서버 측 처리는 발생하지 않는다.",{"type":20,"tag":21,"props":206,"children":207},{},[208],{"type":25,"value":30},{"type":20,"tag":210,"props":211,"children":213},"img",{"src":212},"../images/cc768cfe-b424-4c59-840f-5943ba305561.png",[],{"type":20,"tag":215,"props":216,"children":217},"hr",{},[],{"title":8,"searchDepth":219,"depth":219,"links":220},2,[221],{"id":70,"depth":219,"text":73},"markdown","content:posts:9ecb10c2-fa24-449c-ac39-8553ee942084.md","content","posts/9ecb10c2-fa24-449c-ac39-8553ee942084.md","md",1706961050797]